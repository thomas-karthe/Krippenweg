<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Krippenweg – eingebettete KML</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
          integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

  <style>
    html, body { height:100%; margin:0; }
    .map-wrap { position:relative; width:100%; height:100vh; overflow:hidden; }
    #map { position:absolute; inset:0; width:100%; height:100%; background:#eaeaea; }

    .overlay {
      position:absolute; top:60px; left:16px; z-index:1000;
      max-width:min(420px, 90vw); max-height:calc(100vh - 92px);
      overflow:auto; padding:16px 16px 12px;
      border-radius:12px; background:rgba(255,255,255,0.92);
      box-shadow:0 10px 30px rgba(0,0,0,0.15);
      font:500 16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
    }
    .overlay h2 { margin:0 0 8px; font-weight:600; font-size:18px; }
    .fancy-list { list-style:none; counter-reset:item; padding:0; margin:8px 0 0; }
    .fancy-list li {
      counter-increment:item; margin:10px 0; position:relative; padding-left:44px; cursor:pointer; color:#111;
    }
    .fancy-list li::before {
      content:counter(item);
      position:absolute; left:0; top:50%; transform:translateY(-50%);
      background:#993355; color:#fff; width:30px; height:30px; border-radius:50%;
      display:flex; align-items:center; justify-content:center;
      font-weight:700; font-size:15px;
    }
    .fancy-list li:hover { text-decoration:underline; }
    .overlay-toggle {
      position:absolute; top:12px; right:16px; z-index:1001;
      border:0; border-radius:10px; padding:10px 12px;
      font:600 14px/1 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      background:rgba(0,0,0,0.65); color:#fff; cursor:pointer;
    }
    .error {
      position:absolute; left:16px; bottom:16px; z-index:1002;
      background:#ffefef; color:#9a0000; border:1px solid #f3b8b8;
      padding:8px 10px; border-radius:8px; font:13px/1.3 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      max-width:min(520px, 90vw);
    }
  </style>
</head>
<body>
  <div class="map-wrap">
    <div id="map"></div>

    <button class="overlay-toggle" onclick="
      const p = document.getElementById('overlay');
      const open = p.style.display !== 'none';
      p.style.display = open ? 'none' : 'block';
      this.textContent = open ? 'Liste anzeigen' : 'Liste ausblenden';
    ">Liste ausblenden</button>

    <aside id="overlay" class="overlay">
      <h2>Krippenweg 2025/26</h2>
      <ol id="poi-list" class="fancy-list"></ol>
    </aside>

    <div id="err" class="error" style="display:none"></div>
  </div>

  <script>
    // === 1) Eingebettete KML-Daten ===
    const KML = String.raw`<kml xmlns="http://www.opengis.net/kml/2.2">
  <Document>
    <name>Krippenweg 2025/26</name>
    <description>Evangelisch-methodistische Kirche</description>

    <!-- 24 Symbole -->
    ${[...Array(24).keys()].map(i => `
      <Style id="icon-${i+1}-normal"><IconStyle><scale>1</scale><Icon><href>images/icon-${i+1}.png</href></Icon></IconStyle><LabelStyle><scale>0</scale></LabelStyle></Style>
      <Style id="icon-${i+1}-highlight"><IconStyle><scale>1</scale><Icon><href>images/icon-${i+1}.png</href></Icon></IconStyle><LabelStyle><scale>1</scale></LabelStyle></Style>
      <StyleMap id="icon-${i+1}"><Pair><key>normal</key><styleUrl>#icon-${i+1}-normal</styleUrl></Pair><Pair><key>highlight</key><styleUrl>#icon-${i+1}-highlight</styleUrl></Pair></StyleMap>
    `).join('')}

    <!-- Placemark-Daten -->
    <Folder><name>Stationen</name>
      <Placemark><name>Rathaus</name><styleUrl>#icon-1</styleUrl><Point><coordinates>8.996512,48.62786,0</coordinates></Point></Placemark>
      <Placemark><name>Schaichhofstraße 4</name><styleUrl>#icon-2</styleUrl><Point><coordinates>8.996485,48.627028,0</coordinates></Point></Placemark>
      <Placemark><name>Schaichhofstraße 3</name><styleUrl>#icon-3</styleUrl><Point><coordinates>8.996985,48.626935,0</coordinates></Point></Placemark>
      <Placemark><name>Schaichhofstraße 7</name><styleUrl>#icon-4</styleUrl><Point><coordinates>8.997268,48.627001,0</coordinates></Point></Placemark>
      <Placemark><name>Schaichhofstraße 7/1</name><styleUrl>#icon-5</styleUrl><Point><coordinates>8.997516,48.627066,0</coordinates></Point></Placemark>
      <Placemark><name>EMK Baum</name><styleUrl>#icon-6</styleUrl><Point><coordinates>8.997162,48.626784,0</coordinates></Point></Placemark>
      <Placemark><name>EMK Eingang</name><styleUrl>#icon-7</styleUrl><Point><coordinates>8.997247,48.626807,0</coordinates></Point></Placemark>
      <Placemark><name>EMK Schaukasten</name><styleUrl>#icon-8</styleUrl><Point><coordinates>8.99722,48.626733,0</coordinates></Point></Placemark>
      <Placemark><name>Schaichhofstraße 9</name><styleUrl>#icon-9</styleUrl><Point><coordinates>8.997467,48.626628,0</coordinates></Point></Placemark>
      <Placemark><name>Weilemer Weg 11</name><styleUrl>#icon-10</styleUrl><Point><coordinates>8.998046,48.626556,0</coordinates></Point></Placemark>
      <Placemark><name>Schulstraße/Weilemer Weg</name><styleUrl>#icon-11</styleUrl><Point><coordinates>8.998644,48.626702,0</coordinates></Point></Placemark>
      <Placemark><name>Schaichhofstraße 32</name><styleUrl>#icon-12</styleUrl><Point><coordinates>8.999575,48.625318,0</coordinates></Point></Placemark>
      <Placemark><name>Schaichhofstraße 16</name><styleUrl>#icon-13</styleUrl><Point><coordinates>8.997858,48.626355,0</coordinates></Point></Placemark>
      <Placemark><name>Schaichhofstraße 10</name><styleUrl>#icon-14</styleUrl><Point><coordinates>8.997009,48.626693,0</coordinates></Point></Placemark>
      <Placemark><name>Milchstraße 10</name><styleUrl>#icon-15</styleUrl><Point><coordinates>8.996024,48.626455,0</coordinates></Point></Placemark>
      <Placemark><name>Bachstraße/Stützenstraße</name><styleUrl>#icon-16</styleUrl><Point><coordinates>8.995117,48.628532,0</coordinates></Point></Placemark>
      <Placemark><name>Kastanie Mühlstraße</name><styleUrl>#icon-17</styleUrl><Point><coordinates>8.990766,48.629751,0</coordinates></Point></Placemark>
      <Placemark><name>Brombergweg 17</name><styleUrl>#icon-18</styleUrl><Point><coordinates>8.990431,48.629361,0</coordinates></Point></Placemark>
      <Placemark><name>Brombergweg 23</name><styleUrl>#icon-19</styleUrl><Point><coordinates>8.9897474,48.6296091,0</coordinates></Point></Placemark>
      <Placemark><name>Samariterstift</name><styleUrl>#icon-20</styleUrl><Point><coordinates>8.989474,48.630042,0</coordinates></Point></Placemark>
      <Placemark><name>Friedhof</name><styleUrl>#icon-21</styleUrl><Point><coordinates>8.99485,48.630699,0</coordinates></Point></Placemark>
      <Placemark><name>Schillerstraße 70</name><styleUrl>#icon-22</styleUrl><Point><coordinates>9.0014384,48.6307412,0</coordinates></Point></Placemark>
      <Placemark><name>Bühlstraße/Schulstraße</name><styleUrl>#icon-23</styleUrl><Point><coordinates>8.997864,48.628697,0</coordinates></Point></Placemark>
      <Placemark><name>Simonsen Haus</name><styleUrl>#icon-24</styleUrl><Point><coordinates>8.996768,48.628338,0</coordinates></Point></Placemark>
    </Folder>
  </Document>
</kml>`;

    // === 2) Leaflet-Karte ===
    const map = L.map('map').setView([48.6279, 8.9965], 15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 20, attribution: '&copy; OpenStreetMap-Mitwirkende'
    }).addTo(map);

    // === 3) Parser und Darstellung ===
    const ICONS_BASE = 'images/';
    const KML_NS = 'http://www.opengis.net/kml/2.2';
    const byTag = (p, t) => Array.from(p.getElementsByTagNameNS(KML_NS, t));
    const txt = e => e ? e.textContent.trim() : '';
    const resolveHref = href => /^https?:/.test(href) ? href : ICONS_BASE + href.replace(/^.*\//, '');

    const iconCache = new Map();
    const iconFor = url => {
      if (!url) return undefined;
      if (iconCache.has(url)) return iconCache.get(url);
      const ic = L.icon({ iconUrl:url, iconSize:[32,32], iconAnchor:[16,32] });
      iconCache.set(url, ic);
      return ic;
    };

    function collectIcons(xml) {
      const styles = new Map();
      byTag(xml, 'Style').forEach(s => {
        const id = s.getAttribute('id');
        const hrefNode = s.getElementsByTagName('href')[0];
        if (id && hrefNode) styles.set('#' + id, resolveHref(txt(hrefNode)));
      });
      byTag(xml, 'StyleMap').forEach(sm => {
        const id = sm.getAttribute('id'); if (!id) return;
        const pairs = byTag(sm, 'Pair');
        let chosen = null;
        for (const key of ['normal','highlight']) {
          const p = pairs.find(px => txt(byTag(px, 'key')[0]) === key);
          const su = p && txt(byTag(p, 'styleUrl')[0]);
          if (su && styles.has(su)) { chosen = styles.get(su); break; }
        }
        if (chosen) styles.set('#' + id, chosen);
      });
      return styles;
    }

    function parseCoords(raw) {
      const [lon, lat] = raw.trim().split(',').map(Number);
      return [lat, lon];
    }

    (function render() {
      const xml = new DOMParser().parseFromString(KML, 'application/xml');
      const styles = collectIcons(xml);
      const list = document.getElementById('poi-list');
      const placemarks = byTag(xml, 'Placemark');
      const markers = [];

      placemarks.forEach(pm => {
        const pt = byTag(pm, 'Point')[0];
        if (!pt) return;
        const coord = txt(byTag(pt, 'coordinates')[0]);
        const [lat, lon] = parseCoords(coord);
        const name = txt(byTag(pm, 'name')[0]);
        const styleUrl = txt(byTag(pm, 'styleUrl')[0]);
        const iconHref = styleUrl ? styles.get(styleUrl) : null;

        const marker = L.marker([lat, lon], { icon: iconFor(iconHref) })
          .addTo(map)
          .bindPopup(`<strong>${name}</strong>`);
        markers.push(marker);

        const li = document.createElement('li');
        li.textContent = name;
        li.onclick = () => { map.flyTo([lat, lon], 18, { animate:true, duration:0.9 }); marker.openPopup(); };
        list.appendChild(li);
      });

      if (markers.length) map.fitBounds(L.featureGroup(markers).getBounds().pad(0.15));
    })();
  </script>
</body>
</html>
